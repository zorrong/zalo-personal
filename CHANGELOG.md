# Changelog

All notable changes to the zalo-personal OpenClaw extension will be documented in this file.

## [1.3.1] - 2026-02-14

### Fixed
- **Native Image Detection**: Fixed image detection in current prompt vs history
  - Images now properly recognized as "in prompt" instead of "in history"
  - LLM vision/analysis now uses the correct uploaded image
  - Resolved issue where bot analyzed old images instead of new ones

## [1.3.0] - 2026-02-14

### Added
- **Native Image Input Support**: Download images from Zalo messages for use as input to AI skills
  - New `image-downloader.ts` module for downloading images from URLs
  - Automatic download of images sent by users to local files
  - Images saved to `~/.openclaw/workspace/media/` with timestamped filenames
  - Full integration with nano-banana and other image-processing skills
  - Support for multiple images (multi-image composition up to 14 images)
  - Proper error handling and fallback to URLs if download fails

### Technical Details
- Downloaded images replace URL references in message context
- Local file paths passed to OpenClaw's native image system
- Works seamlessly with image editing, analysis, and composition tasks

## [1.2.4] - 2026-02-14

### Fixed
- **Race Condition**: Fixed auto-cleanup deleting files before OpenClaw processing
  - Changed `cleanupAfterUpload` default from `true` to `false`
  - Prevents file deletion before MEDIA: token processing completes
  - OpenClaw now manages file lifecycle correctly
  - Fixes issue where nano-banana couldn't find generated images

## [1.2.3] - 2026-02-14

### Added
- **Image Metadata Support**: Added `imageMetadataGetter` for zca-js v2.0+ compatibility
  - Uses `sharp` library to read image dimensions (width, height, size)
  - Required for zca-js uploadAttachment to work correctly
  - Fixes "Missing imageMetadataGetter" error when uploading images

## [1.2.2] - 2026-02-14

### Fixed
- **Session Routing**: Fixed DM messages incorrectly routed to per-channel sessions
  - Bug: Both DM and group messages were set as `kind: "group"`
  - Fix: DM messages now correctly use `kind: "direct"`
  - DM messages now appear in main:main session like Telegram
  - Messages now visible in OpenClaw webui
  - Proper integration with `session.dmScope = "main"` configuration

## [1.2.1] - 2026-02-14

### Added
- **Local File Upload**: Upload local images generated by AI skills to Zalo
  - New `uploadAndSendLocalImage()` function for direct file uploads
  - Auto-detection of local file paths in message sending
  - Integration with zca-js `sendMessage` attachments parameter
  - Support for AI-generated images from skills like nano-banana
  - Automatic cleanup option for local files after upload (optional)

### Features
- Seamless workflow: AI generates image → upload to Zalo → send to user
- Works with all image formats supported by zca-js
- Local path detection: automatically uploads if path starts with `/` and file exists

## [1.2.0] - 2026-02-13

### Added
- Initial media support groundwork
- Prepared infrastructure for image handling

---

## [1.1.2] - Previous Stable

### Features
- QR Code login via zca-js
- Pairing mode for access control
- Group and direct message support
- Automatic QR cleanup
- Gateway restart prompt
- Blocklist/Denylist support

